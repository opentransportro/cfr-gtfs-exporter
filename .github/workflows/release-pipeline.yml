name: Release Generator

on:
  workflow_dispatch:   
    inputs:
          version:
            description: 'Release version (e.g. v0.1.0)'
            required: true
          message:
            description: 'Tag message'
            required: true
jobs:
  release:

    runs-on: ubuntu-latest

    steps:
    - name: Get current date
      id: date
      run: echo "name=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
    - uses: actions/checkout@v2
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.6
    - name: Install dependencies
      run: gem install nokogiri
    - name: Run generator
      run: |
        ruby parse.rb
        wget http://download.geofabrik.de/europe/romania-latest.osm.bz2
        bzip2 -d romania-latest.osm.bz2 
        docker run --rm -v ${PWD}:/workdir opentransport/pfaedle pfaedle -D -d /workdir/gtfs-out -o /workdir/gtfs-processed --write-trgraph --write-graph --write-cgraph -mall -x /workdir/romania-latest.osm /workdir/gtfs-out
        zip -rj gtfs-cfr.zip gtfs-processed
    - name: Create Tag
      uses: negz/create-tag@v1
      with:
        version: ${{ github.event.inputs.version }}
        message: ${{ github.event.inputs.message }}
        token: ${{ secrets.GH_TOKEN }}
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      with:
        name: Release ${{ steps.date.outputs.date }}
        body: Updating to the lastet version of data provided by cfr
        tag_name: ${{ github.event.inputs.version }}
        draft: false
        prerelease: false
        files: |
            gtfs-cfr.zip
            gtfs-out/trgraph-rail.json

